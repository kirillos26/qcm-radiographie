<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Questionnaire ‚Äî QCM & QRO</title>
  <style>
    :root{
      --border:#e5e7eb; --muted:#6b7280; --bg:#ffffff; --soft:#f9fafb;
      --ok:#16a34a; --ko:#dc2626; --ink:#111827;
    }
    body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin:24px; line-height:1.45; color:var(--ink); background:var(--bg);
    }
    header{ max-width:980px; margin:0 auto 14px auto; }
    h1{ font-size:1.45rem; margin:0 0 8px 0; display:flex; align-items:center; gap:10px; }
    .sub{ margin:0 0 14px 0; color:var(--muted); }
    .bar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button{
      padding:9px 12px; border:1px solid #9ca3af; border-radius:12px;
      background:var(--soft); cursor:pointer;
    }
    button.primary{ background:#111827; color:#fff; border-color:#111827; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .meta{ margin-left:auto; color:var(--muted); font-size:.95rem; }

    main{ max-width:980px; margin:14px auto 44px auto; display:flex; flex-direction:column; gap:14px; }
    .card{
      border:1px solid var(--border); border-radius:16px; padding:14px 14px 12px 14px;
      background:#fff;
    }
    .topline{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    .title{ margin:0; font-size:1.05rem; display:flex; align-items:center; gap:8px; }
    .pill{
      display:inline-block; font-size:.82rem; padding:2px 9px; border:1px solid var(--border);
      border-radius:999px; color:var(--muted); white-space:nowrap;
    }
    .prompt{ margin:8px 0 10px 0; }
    .choices{ display:flex; flex-direction:column; gap:8px; margin:10px 0 10px 0; }
    label.choice{ display:flex; gap:10px; align-items:flex-start; }
    input[type="checkbox"], input[type="radio"]{ margin-top:3px; transform:scale(1.1); }
    textarea{
      width:100%; min-height:92px; resize:vertical; padding:10px;
      border-radius:12px; border:1px solid var(--border); font:inherit;
    }
    .controls{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 6px 0; }
    .feedback{
      margin-top:10px; padding:10px 12px; border-radius:14px; border:1px solid var(--border);
      background:#fafafa; white-space:pre-wrap;
    }
    .feedback.ok{ border-color:#86efac; background:#f0fdf4; }
    .feedback.ko{ border-color:#fca5a5; background:#fef2f2; }
    .muted{ color:var(--muted); }
    .sep{ height:1px; background:var(--border); margin:10px 0; }

    /* Ic√¥nes inline */
    .ico{ width:18px; height:18px; display:inline-block; vertical-align:-3px; }
    .ico svg{ width:18px; height:18px; }
  </style>
</head>
<body>
<header>
  <h1>
    <span class="ico" aria-hidden="true">
      <!-- petit pictogramme "quiz" -->
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M7 7h10M7 12h7M7 17h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M5 3h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z"
              stroke="currentColor" stroke-width="2"/>
      </svg>
    </span>
    Questionnaire ‚Äî QCM & QRO
  </h1>

  <div class="bar">
    <button class="primary" id="btnNew">Nouveau tirage</button>
    <span class="meta" id="meta"></span>
  </div>
</header>

<main id="app"></main>

<script>
/** =========================
 *  1) BANQUE DE QUESTIONS (√† remplir ensuite depuis tes PDF)
 *  ========================= */
// =======================
// QUESTION_BANK ‚Äî PARTIE 1
// Module 3 + Physio/Patho (semaines 1-2)
// solutionText = explication (sans lettres, sans "Bonne(s) r√©ponse(s)")
// =======================

const QUESTION_BANK = [

  {
    id: "radio_1",
    type: "QCM",
    mode: "single",
    icon: "ü©ª",
    prompt: "En incidence PA du thorax, pourquoi demande-t-on une inspiration maximale ?",
    choices: [
      { text: "Augmenter la densit√© pulmonaire", correct: false },
      { text: "Abaisser le diaphragme et mieux d√©ployer les champs pulmonaires", correct: true },
      { text: "R√©duire la taille apparente du c≈ìur", correct: false },
      { text: "Diminuer la dose re√ßue par le patient", correct: false }
    ],
    solutionText:
      "Une inspiration profonde abaisse le diaphragme et permet une meilleure expansion des poumons, am√©liorant l‚Äôanalyse des structures pulmonaires."
  },

  {
    id: "radio_2",
    type: "QCM",
    mode: "multi",
    icon: "ü©ª",
    prompt: "Quels crit√®res indiquent un bon positionnement en radiographie thoracique PA ?",
    choices: [
      { text: "Clavicules sym√©triques par rapport aux apophyses √©pineuses", correct: true },
      { text: "Scapulas projet√©es sur les champs pulmonaires", correct: false },
      { text: "Inspiration suffisante avec visualisation d‚Äôau moins 10 arcs costaux post√©rieurs", correct: true },
      { text: "Rotation du patient vers la droite", correct: false }
    ],
    solutionText:
      "L‚Äôabsence de rotation (clavicules sym√©triques) et une inspiration suffisante sont des crit√®res majeurs de qualit√© en thorax PA."
  },

  {
    id: "radio_3",
    type: "QCM",
    mode: "single",
    icon: "ü©ª",
    prompt: "Pourquoi privil√©gie-t-on une incidence PA plut√¥t que AP pour le thorax chez un patient debout ?",
    choices: [
      { text: "R√©duire l‚Äôagrandissement du c≈ìur", correct: true },
      { text: "Augmenter la visibilit√© des c√¥tes post√©rieures", correct: false },
      { text: "Diminuer le contraste pulmonaire", correct: false },
      { text: "Faciliter la visualisation du m√©diastin sup√©rieur", correct: false }
    ],
    solutionText:
      "L‚Äôincidence PA limite l‚Äôagrandissement g√©om√©trique du c≈ìur car celui-ci est plus proche du d√©tecteur."
  },

  {
    id: "radio_4",
    type: "QRO",
    icon: "ü©ª",
    prompt: "Expliquer l‚Äôint√©r√™t d‚Äôune distance foyer-d√©tecteur √©lev√©e (‚âà 180 cm) en radiographie thoracique.",
    modelAnswer:
      "Une grande distance foyer-d√©tecteur r√©duit l‚Äôagrandissement et les distorsions, am√©liorant la fid√©lit√© des dimensions, notamment pour l‚Äô√©valuation cardiaque."
  },

  {
    id: "radio_5",
    type: "QCM",
    mode: "single",
    icon: "ü©ª",
    prompt: "En radiographie du genou de face, quelle structure doit √™tre centr√©e sur le d√©tecteur ?",
    choices: [
      { text: "La rotule uniquement", correct: false },
      { text: "L‚Äôinterligne f√©moro-tibial", correct: true },
      { text: "Le condyle f√©moral lat√©ral", correct: false },
      { text: "La tub√©rosit√© tibiale", correct: false }
    ],
    solutionText:
      "Le centrage sur l‚Äôinterligne articulaire permet une √©valuation correcte de l‚Äôespace articulaire et des structures osseuses."
  },

  {
    id: "radio_6",
    type: "QCM",
    mode: "multi",
    icon: "ü©ª",
    prompt: "Quels √©l√©ments influencent la nettet√© g√©om√©trique d‚Äôune image radiographique ?",
    choices: [
      { text: "Taille du foyer", correct: true },
      { text: "Distance objet-d√©tecteur", correct: true },
      { text: "Distance foyer-d√©tecteur", correct: true },
      { text: "Couleur du d√©tecteur", correct: false }
    ],
    solutionText:
      "La nettet√© d√©pend des param√®tres g√©om√©triques : taille du foyer, distances foyer-d√©tecteur et objet-d√©tecteur."
  },

  {
    id: "radio_7",
    type: "QCM",
    mode: "single",
    icon: "ü©ª",
    prompt: "Quelle est la position recommand√©e pour une incidence lat√©rale du rachis lombaire ?",
    choices: [
      { text: "D√©cubitus dorsal", correct: false },
      { text: "D√©cubitus lat√©ral avec genoux fl√©chis", correct: true },
      { text: "Procubitus", correct: false },
      { text: "Position debout bras lev√©s", correct: false }
    ],
    solutionText:
      "Le d√©cubitus lat√©ral avec flexion des membres inf√©rieurs r√©duit la lordose lombaire et am√©liore l‚Äôalignement."
  },

  {
    id: "radio_8",
    type: "QCM",
    mode: "single",
    icon: "ü©ª",
    prompt: "Pourquoi demande-t-on l‚Äôimmobilit√© du patient pendant l‚Äôexposition ?",
    choices: [
      { text: "Augmenter le contraste", correct: false },
      { text: "√âviter le flou de mouvement", correct: true },
      { text: "R√©duire la dose", correct: false },
      { text: "Am√©liorer la p√©n√©tration des rayons", correct: false }
    ],
    solutionText:
      "Le mouvement pendant l‚Äôexposition entra√Æne un flou cin√©tique qui d√©grade la r√©solution spatiale."
  },

  {
    id: "radio_9",
    type: "QRO",
    icon: "ü©ª",
    prompt: "Pourquoi utilise-t-on une grille anti-diffusante pour certaines radiographies ?",
    modelAnswer:
      "La grille r√©duit le rayonnement diffus√©, am√©liore le contraste de l‚Äôimage mais n√©cessite g√©n√©ralement une augmentation de l‚Äôexposition."
  },

  {
    id: "radio_10",
    type: "QCM",
    mode: "single",
    icon: "ü©ª",
    prompt: "En incidence AP de l‚Äô√©paule, quelle structure doit √™tre d√©gag√©e pour une bonne analyse ?",
    choices: [
      { text: "L‚Äôarticulation acromio-claviculaire", correct: false },
      { text: "L‚Äôespace gl√©no-hum√©ral", correct: true },
      { text: "La clavicule m√©diale", correct: false },
      { text: "La scapula enti√®re", correct: false }
    ],
    solutionText:
      "Le bon positionnement vise √† visualiser clairement l‚Äôinterligne gl√©no-hum√©ral pour √©valuer congruence et l√©sions."
  },

  {
    id: "radio_11",
    type: "QCM",
    mode: "multi",
    icon: "ü©ª",
    prompt: "Quels facteurs augmentent la dose re√ßue par le patient ?",
    choices: [
      { text: "Augmentation du mAs", correct: true },
      { text: "R√©p√©tition d‚Äôexamens", correct: true },
      { text: "Collimation ad√©quate", correct: false },
      { text: "Distance foyer-peau r√©duite", correct: true }
    ],
    solutionText:
      "Une augmentation du mAs, des r√©p√©titions et une distance plus faible augmentent la dose absorb√©e."
  },

  {
    id: "radio_12",
    type: "QCM",
    mode: "single",
    icon: "ü©ª",
    prompt: "Quel est l‚Äôobjectif principal de la collimation ?",
    choices: [
      { text: "Augmenter la r√©solution", correct: false },
      { text: "Limiter le champ irradi√© et r√©duire la diffusion", correct: true },
      { text: "Augmenter la dose", correct: false },
      { text: "Modifier la taille du foyer", correct: false }
    ],
    solutionText:
      "La collimation r√©duit la zone irradi√©e, diminue le diffus√© et am√©liore le contraste."
  },

  {
    id: "radio_13",
    type: "QRO",
    icon: "ü©ª",
    prompt: "Expliquer pourquoi une rotation du patient fausse l‚Äôinterpr√©tation d‚Äôune radiographie thoracique.",
    modelAnswer:
      "La rotation modifie les rapports anatomiques apparents (clavicules, m√©diastin, c≈ìur) et peut simuler ou masquer des pathologies."
  },

  {
    id: "radio_14",
    type: "QCM",
    mode: "single",
    icon: "ü©ª",
    prompt: "En radiographie du bassin de face, quelle est la position des membres inf√©rieurs recommand√©e ?",
    choices: [
      { text: "Rotation interne d‚Äôenviron 15¬∞", correct: true },
      { text: "Rotation externe maximale", correct: false },
      { text: "Flexion des genoux", correct: false },
      { text: "Abduction des hanches", correct: false }
    ],
    solutionText:
      "La rotation interne aligne les cols f√©moraux parall√®lement au d√©tecteur pour une meilleure visualisation."
  },

  {
    id: "radio_15",
    type: "QCM",
    mode: "multi",
    icon: "ü©ª",
    prompt: "Quels √©l√©ments participent √† la radioprotection du patient ?",
    choices: [
      { text: "Utilisation de tabliers plomb√©s", correct: true },
      { text: "Collimation adapt√©e", correct: true },
      { text: "Augmentation syst√©matique du kV", correct: false },
      { text: "Optimisation des param√®tres d‚Äôexposition", correct: true }
    ],
    solutionText:
      "La radioprotection repose sur la limitation du champ, l‚Äôoptimisation des param√®tres et l‚Äôutilisation d‚Äô√©crans plomb√©s."
  },

  {
    id: "radio_16",
    type: "QCM",
    mode: "single",
    icon: "ü©ª",
    prompt: "Quel param√®tre influence principalement le contraste radiographique ?",
    choices: [
      { text: "kV", correct: true },
      { text: "mAs", correct: false },
      { text: "Distance foyer-d√©tecteur", correct: false },
      { text: "Temps d‚Äôexposition uniquement", correct: false }
    ],
    solutionText:
      "Le kilovoltage (kV) d√©termine l‚Äô√©nergie du faisceau et influence fortement le contraste de l‚Äôimage."
  },

  {
    id: "radio_17",
    type: "QRO",
    icon: "ü©ª",
    prompt: "Pourquoi demande-t-on parfois une expiration en radiographie thoracique ?",
    modelAnswer:
      "L‚Äôexpiration peut aider √† mettre en √©vidence certains pneumothorax ou anomalies de mobilit√© diaphragmatique."
  },

  {
    id: "radio_18",
    type: "QCM",
    mode: "single",
    icon: "ü©ª",
    prompt: "Quelle est la cons√©quence principale d‚Äôune distance objet-d√©tecteur trop grande ?",
    choices: [
      { text: "Diminution du contraste", correct: false },
      { text: "Agrandissement et flou g√©om√©trique", correct: true },
      { text: "R√©duction de la dose", correct: false },
      { text: "Augmentation de la nettet√©", correct: false }
    ],
    solutionText:
      "Une distance objet-d√©tecteur √©lev√©e augmente l‚Äôagrandissement et la p√©nombre g√©om√©trique."
  },

  {
    id: "radio_19",
    type: "QCM",
    mode: "multi",
    icon: "ü©ª",
    prompt: "Quels crit√®res indiquent une bonne incidence lat√©rale du thorax ?",
    choices: [
      { text: "Superposition des arcs costaux post√©rieurs", correct: true },
      { text: "Bras √©lev√©s pour d√©gager les champs pulmonaires", correct: true },
      { text: "Rotation du bassin", correct: false },
      { text: "Inspiration profonde", correct: true }
    ],
    solutionText:
      "Une bonne lat√©rale thoracique n√©cessite absence de rotation, bras d√©gag√©s et inspiration suffisante."
  },

  {
    id: "radio_20",
    type: "QRO",
    icon: "ü©ª",
    prompt: "Expliquer l‚Äôint√©r√™t clinique de r√©aliser deux incidences orthogonales en radiographie.",
    modelAnswer:
      "Deux incidences perpendiculaires permettent de localiser pr√©cis√©ment une l√©sion dans l‚Äôespace et d‚Äô√©viter les superpositions trompeuses."
  }

];



/** =========================
 *  2) UTILS
 *  ========================= */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }
function escapeHtml(s){
  if(s==null) return "";
  return String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function sameSet(a,b){
  const A=[...a].sort((x,y)=>x-y), B=[...b].sort((x,y)=>x-y);
  if(A.length!==B.length) return false;
  return A.every((v,i)=>v===B[i]);
}

/** =========================
 *  3) √âTAT + G√âN√âRATION
 *  ========================= */
let state = { questions: [] };

function buildAttempt(){
  const q = deepClone(QUESTION_BANK);

  // Random questions
  shuffle(q);

  // Random choices in each QCM
  for(const item of q){
    if(item.type==="QCM" && Array.isArray(item.choices)) shuffle(item.choices);
  }

  state.questions = q;
  render();
}

function metaText(){
  const total=state.questions.length;
  const nQCM=state.questions.filter(x=>x.type==="QCM").length;
  const nQRO=state.questions.filter(x=>x.type==="QRO").length;
  return `${total} exercices ¬∑ ${nQCM} QCM ¬∑ ${nQRO} QRO`;
}

/** =========================
 *  4) RENDU
 *  ========================= */
function render(){
  document.getElementById("meta").textContent = metaText();

  const app=document.getElementById("app");
  app.innerHTML="";

  state.questions.forEach((q, idx) => {
    const exoNum = idx+1;

    const card=document.createElement("section");
    card.className="card";
    card.dataset.qid=q.id;

    // Header
    const modeLabel = q.type==="QCM"
      ? (q.mode==="single" ? "QCM ¬∑ 1 r√©ponse" : "QCM ¬∑ multi r√©ponses")
      : "QRO";
    const icon = q.icon || (q.type==="QCM" ? "üß©" : "‚úçÔ∏è");

    card.innerHTML = `
      <div class="topline">
        <h3 class="title">${escapeHtml(icon)} Exercice ${exoNum}</h3>
        <span class="pill">${modeLabel}</span>
      </div>
      <div class="prompt">${escapeHtml(q.prompt)}</div>
    `;

    // Body
    if(q.type==="QCM"){
      const list=document.createElement("div");
      list.className="choices";

      const groupName = `grp_${q.id}`;
      q.choices.forEach((c, cidx) => {
        const letter = String.fromCharCode(65 + cidx);
        const inputId = `${q.id}_${cidx}`;

        const row=document.createElement("label");
        row.className="choice";

        const input=document.createElement("input");
        input.type = (q.mode==="single") ? "radio" : "checkbox";
        input.name = groupName;
        input.id = inputId;
        input.dataset.correct = String(!!c.correct);

        const span=document.createElement("span");
        span.innerHTML = `<b>${letter}.</b> ${escapeHtml(c.text)}`;

        row.appendChild(input);
        row.appendChild(span);
        list.appendChild(row);
      });

      card.appendChild(list);

      // Controls: submit per QCM
      const controls=document.createElement("div");
      controls.className="controls";

      const btn=document.createElement("button");
      btn.className="primary";
      btn.textContent="Soumettre";
      btn.addEventListener("click", () => submitOneQCM(q.id));

      const btnReset=document.createElement("button");
      btnReset.textContent="R√©initialiser";
      btnReset.addEventListener("click", () => resetOne(q.id));

      controls.appendChild(btn);
      controls.appendChild(btnReset);
      card.appendChild(controls);
    }

    if(q.type==="QRO"){
      const ta=document.createElement("textarea");
      ta.placeholder="√âcris ta r√©ponse ici‚Ä¶";
      ta.id = `ta_${q.id}`;
      card.appendChild(ta);

      const controls=document.createElement("div");
      controls.className="controls";

      const btn=document.createElement("button");
      btn.className="primary";
      btn.textContent="Soumettre";
      btn.addEventListener("click", () => submitOneQRO(q.id));

      const btnReset=document.createElement("button");
      btnReset.textContent="R√©initialiser";
      btnReset.addEventListener("click", () => resetOne(q.id));

      controls.appendChild(btn);
      controls.appendChild(btnReset);
      card.appendChild(controls);
    }

    // Feedback placeholder
    const fb=document.createElement("div");
    fb.className="feedback";
    fb.style.display="none";
    fb.id = `fb_${q.id}`;
    card.appendChild(fb);

    app.appendChild(card);
  });
}

/** =========================
 *  5) ACTIONS : QCM / QRO
 *  ========================= */
function submitOneQCM(qid){
  const q = state.questions.find(x => x.id===qid);
  if(!q) return;

  const card = document.querySelector(`[data-qid="${qid}"]`);
  const inputs = Array.from(card.querySelectorAll("input"));

  // Gather chosen and correct
  const chosen = inputs.map((el, idx)=>({idx, checked:el.checked}))
                       .filter(x=>x.checked).map(x=>x.idx);
  const correctIdx = inputs.map((el, idx)=>({idx, correct:el.dataset.correct==="true"}))
                           .filter(x=>x.correct).map(x=>x.idx);

  const ok = sameSet(chosen, correctIdx);

  // Disable
  inputs.forEach(el => el.disabled = true);
  card.querySelectorAll("button").forEach(b => { if(b.textContent==="Soumettre") b.disabled = true; });

  // Feedback
  const fb = document.getElementById(`fb_${qid}`);
  fb.style.display="block";
  fb.classList.remove("ok","ko");
  fb.classList.add(ok ? "ok" : "ko");

  const correctLetters = correctIdx.map(i => String.fromCharCode(65+i)).join(", ") || "‚Äî";
  fb.textContent =
    (ok ? "‚úÖ Bonne r√©ponse." : "‚ùå Mauvaise r√©ponse.") + "\n\n" +
    `Bonne(s) r√©ponse(s) : ${correctLetters}\n` +
    (q.solutionText ? q.solutionText : "");
}

function submitOneQRO(qid){
  const q = state.questions.find(x => x.id===qid);
  if(!q) return;

  const card = document.querySelector(`[data-qid="${qid}"]`);
  const ta = card.querySelector("textarea");
  const user = (ta.value || "").trim();

  ta.disabled = true;
  card.querySelectorAll("button").forEach(b => { if(b.textContent==="Soumettre") b.disabled = true; });

  const fb = document.getElementById(`fb_${qid}`);
  fb.style.display="block";
  fb.classList.remove("ok","ko");

  fb.textContent =
    "‚úÖ R√©ponse enregistr√©e.\n\n" +
    `Ta r√©ponse : ${user ? user : "(vide)"}\n\n` +
    `R√©ponse propos√©e : ${q.modelAnswer ? q.modelAnswer : "‚Äî"}`;
}

function resetOne(qid){
  const card = document.querySelector(`[data-qid="${qid}"]`);
  if(!card) return;

  // reset inputs/textarea
  card.querySelectorAll("input").forEach(el => { el.checked=false; el.disabled=false; });
  card.querySelectorAll("textarea").forEach(el => { el.value=""; el.disabled=false; });

  // reset feedback
  const fb = document.getElementById(`fb_${qid}`);
  if(fb){
    fb.style.display="none";
    fb.textContent="";
    fb.classList.remove("ok","ko");
  }

  // re-enable submit button
  card.querySelectorAll("button").forEach(b => b.disabled=false);
}

/** =========================
 *  6) GLOBAL BUTTON
 *  ========================= */
document.getElementById("btnNew").addEventListener("click", () => buildAttempt());

/** =========================
 *  7) INIT (randomize on load)
 *  ========================= */
buildAttempt();
</script>
</body>
</html>
